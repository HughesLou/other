- job-group:
    name: 'jobs'
    jobs:
        - '{project.name}_onpush'
        - '{project.name}_create-jobs'
        - '{project.name}_master-clone'
        - '{project.name}_rebase'
        - '{project.name}_rebase-check'
        - '{project.name}_rebase-undo'

- job-template:
    name: '{project.name}_onpush'
    node: 'master'

    properties:
    - inject:
        properties-content: PYTHONPATH={project.jenkins.virtualenv_python_home}:bootstrap/meta/py:bootstrap/meta/py/lib:bootstrap/meta/py/lib/jenkinsapi

    parameters:
        - string:
            name: BRANCH
            default:
            description: Branch where change has happened
        - string:
            name: FROM_HASH
            default:
            description: Original hash
        - string:
            name: TO_HASH
            default:
            description: Resulting hash

    scm:
        - git:
            url: '{project.bootstrap_git_data.url}'
            refspec: '+refs/heads/{project.bootstrap_git_data.branch}:refs/remotes/origin/{project.bootstrap_git_data.branch}'
            branches:
                - '{project.bootstrap_git_data.branch}'
            wipe-workspace: False
            basedir: bootstrap
            skip-tag: True

    builders:
        - custom-python:
            home: '{project.jenkins.virtualenv_home}'
            shell: |
                unset http_proxy
                python bootstrap/meta/py/orc.py -p {project.name} -e {project.env_name} onpush --branch $BRANCH --from_hash $FROM_HASH --to_hash $TO_HASH

- job-template:
    name: '{project.name}_master-clone'
    node: 'master'

    builders:
        - custom-python:
            home: '{project.jenkins.virtualenv_home}'
            shell: |
                unset http_proxy
                git clone {project.repository.git_data.url} {project.repository.git_data.master_repo}

- job-template:
    name: '{project.name}_create-jobs'
    node: 'master'

    properties:
        - inject:
            properties-content: PYTHONPATH={project.jenkins.virtualenv_python_home}:bootstrap/meta/py:bootstrap/meta/py/lib:bootstrap/meta/py/lib/jenkinsapi

    scm:
        - git:
            url: '{project.bootstrap_git_data.url}'
            refspec: '+refs/heads/{project.bootstrap_git_data.branch}:refs/remotes/origin/{project.bootstrap_git_data.branch}'
            branches:
                - '{project.bootstrap_git_data.branch}'
            wipe-workspace: False
            basedir: bootstrap
            skip-tag: True

    builders:
        - custom-python:
            home: '{project.jenkins.virtualenv_home}'
            shell: |
                unset http_proxy
                python bootstrap/meta/py/orc.py -p {project.name} -e {project.env_name} jenkins

- job-template:
    name: '{project.name}_rebase'
    node: 'master'

    properties:
        - inject:
            properties-content: PYTHONPATH={project.jenkins.virtualenv_python_home}:bootstrap/meta/py:bootstrap/meta/py/lib:bootstrap/meta/py/lib/jenkinsapi

    scm:
        - git:
            url: '{project.bootstrap_git_data.url}'
            refspec: '+refs/heads/{project.bootstrap_git_data.branch}:refs/remotes/origin/{project.bootstrap_git_data.branch}'
            branches:
                - '{project.bootstrap_git_data.branch}'
            wipe-workspace: False
            basedir: bootstrap
            skip-tag: True

    builders:
        - shell: |
            set +x
            echo "REBASE_BUILD for {project.name}-rebase-undo (if needed): $BUILD_ID"
            echo "This job does nothing before people will be given a chance to know what this entails"
        # - custom-python:
        #     home: '{project.jenkins.virtualenv_home}'
        #     shell: |
        #         unset http_proxy
        #         # Next line is required in order to remove SSH messages from Git output
        #         export GIT_SSH="/home/sabredev/.ssh/git_ssh.sh"
        #         python bootstrap/meta/py/orc.py -p {project.name} -e {project.env_name} rebase

- job-template:
    name: '{project.name}_rebase-check'
    node: 'master'

    properties:
        - inject:
            properties-content: PYTHONPATH={project.jenkins.virtualenv_python_home}:bootstrap/meta/py:bootstrap/meta/py/lib:bootstrap/meta/py/lib/jenkinsapi:$PYTHONPATH

    scm:
        - git:
            url: '{project.bootstrap_git_data.url}'
            refspec: '+refs/heads/{project.bootstrap_git_data.branch}:refs/remotes/origin/{project.bootstrap_git_data.branch}'
            branches:
                - '{project.bootstrap_git_data.branch}'
            wipe-workspace: False
            basedir: bootstrap
            skip-tag: True

    builders:
        - custom-python:
            home: '{project.jenkins.virtualenv_home}'
            shell: |
                unset http_proxy
                # Next line is required in order to remove SSH messages from Git output
                export GIT_SSH="/home/sabredev/.ssh/git_ssh.sh"
                python bootstrap/meta/py/orc.py -p {project.name} -e {project.env_name} rebase
                python bootstrap/meta/py/orc.py -p {project.name} -e {project.env_name} rebase --undo --build $BUILD_ID

- job-template:
    name: '{project.name}_rebase-undo'
    node: 'master'

    parameters:
        - string:
            name: REBASE_BUILD
            default:
            description: "BUILD_ID taken from rebase.log in {project.name}-rebase job workspace"

    properties:
        - inject:
            properties-content: PYTHONPATH={project.jenkins.virtualenv_python_home}:bootstrap/meta/py:bootstrap/meta/py/lib:bootstrap/meta/py/lib/jenkinsapi:$PYTHONPATH

    scm:
        - git:
            url: '{project.bootstrap_git_data.url}'
            refspec: '+refs/heads/{project.bootstrap_git_data.branch}:refs/remotes/origin/{project.bootstrap_git_data.branch}'
            branches:
                - '{project.bootstrap_git_data.branch}'
            wipe-workspace: False
            basedir: bootstrap
            skip-tag: True

    builders:
        - custom-python:
            home: '{project.jenkins.virtualenv_home}'
            shell: |
                unset http_proxy
                # Next line is required in order to remove SSH messages from Git output
                export GIT_SSH="/home/sabredev/.ssh/git_ssh.sh"
                python bootstrap/meta/py/orc.py -p {project.name} -e {project.env_name} rebase --undo --build $REBASE_BUILD

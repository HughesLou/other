- job-group: 
    name: 'jobs'
    jobs:
        - '{name}__create_cr'
        - '{name}__scm_submit'
        - '{name}__submit_cr'

- job-template:
    name: '{name}__create_cr'
    display-name: 'Create draft CR'
    node: 'master'
    logrotate:
        daysToKeep: -1
        numToKeep: 20
        artifactDaysToKeep: -1
        artifactNumToKeep: -1

    parameters:
        '{project.remedy_cr.cr_dynamic_fields}'

    builders:
        - shell: |
            if [ "$PASSWORD" == "" ]; then
                echo "PASSWORD parameter cannot left blank"
                return 503
            fi
            if [ "$CR_FIELD_0" == "" ]; then
                echo "No CR forms fields found. Plese put 'remedy-cr' section into project.yaml in bootstrap"
                return 503
            fi
        - shell: |
            echo "Raising CR"
            echo "CR_NUMBER=12345" > ./{name}_CR.properties
        - trigger-builds:
            - project: "{name}__scm_submit"

    publishers:
        - archive:
            artifacts: "{name}_CR.properties"

- job-template:
    name: '{name}__scm_submit'
    display-name: 'Submit binaries to SCM'
    node: 'master'
    # workspace: '{master-workspace}'
    logrotate:
        daysToKeep: -1
        numToKeep: 10
        artifactDaysToKeep: -1
        artifactNumToKeep: -1

    scm:
        - git:
            url: '{project.bootstrap_git_data.url}'
            refspec: '+refs/heads/{project.bootstrap_git_data.branch}:refs/remotes/origin/{project.bootstrap_git_data.branch}'
            branches:
                - '{project.bootstrap_git_data.branch}'
            wipe-workspace: False
            basedir: bootstrap
            skip-tag: True

    builders:
        - copyartifact:
            project: '{name}__create_cr'
            filter: '{name}_CR.properties'
            target:
            which_build: last-successful
        - shell: |
            source '{name}_CR.properties'
            echo "Submitting to DOD, CR is $CR_NUMBER"
            echo "DOD_NUMBER=DOD0000000" >> ./{name}_CR.properties
        - custom-python:
            home: '{project.jenkins.virtualenv_home}'
            shell: |
                export SVN_PYTHON_TRACE=True
                echo python bootstrap/meta/py/scmvault.py -p $COMPONENT -v $VERSION -u $SCM_USERNAME -w $SCM_PASSWORD --cr $CR_NUMBER --url $ARTEFACT_URL/{project.artefact_prefix}-{project.component_version.full_version}.{project.artefact_suffix} --config bootstrap/meta/projects/BASE/dod_config.yaml
        - shell: |
            source '{name}_CR.properties'
            echo "Have DOD number"
            echo "DOD_NUMBER=DOD0000000" >> ./{name}_CR.properties
        - trigger-builds:
            - project: "{name}__submit_cr"

    publishers:
        - archive:
            artifacts: "{name}_CR.properties"

- job-template:
    name: '{name}__submit_cr'
    display-name: 'Submit CR with DOD number'
    node: 'master'
    logrotate:
        daysToKeep: -1
        numToKeep: 10
        artifactDaysToKeep: -1
        artifactNumToKeep: -1

    builders:
        - copyartifact:
            project: '{name}__scm_submit'
            filter: '{name}_CR.properties'
            target:
            which_build: last-successful
        - shell: |
            source {name}_CR.properties
            echo "Submitting CR $CR_NUMBER with DOD $DOD_NUMBER"
